(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{290:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return Y}));var n=i(0),a=i.n(n),o=i(47);let l=[],s=new Map,r=!1,h=0,c=0,d=null,g=null,u=null,m=null,f=[];const p=new class{get_at(e){return this.heightmap[Math.floor(e)]}set_at(e,t){this.heightmap[Math.floor(e)]=Math.floor(t)}set_heightmap(e){this.heightmap=e,this.size=e.length}apply(e,t){console.log("SERVER APPLY"),t=t.reverse();for(let i=e;i<e+t.length;i++)this.heightmap[i]<=t[i-e][1]?(f.push({x:i,y:t[i-e][1],column_height:this.heightmap[i]-t[i-e][1]}),this.heightmap[i]=t[i-e][0]+(t[i-e][1]-this.heightmap[i])):this.heightmap[i]=t[i-e][0]}draw(e){e.beginPath(),e.moveTo(0,this.heightmap[0]);for(let t=0;t<this.size;t++)e.lineTo(t,this.heightmap[t]);e.lineTo(this.size,1e3),e.lineTo(0,1e3),e.fillStyle="black",e.fill()}};function y(e,t,i){return Math.min(Math.max(e,t),i)}function _(){let[e,t]=T.get_firing_point();console.log(e),console.log(D);let i=h-e-D,n=c-t,a=Math.sqrt(i*i+n*n),o=Math.atan2(n,i);return[e+Math.cos(o)*y(a,0,200),t+Math.sin(o)*y(a,0,200)]}class x{constructor(e,t){this.x=e,this.y=t}draw(e){console.error("draw() called on base Object")}update(e,t){console.error("update() called on base Object")}}class v extends x{constructor(e,t,i,n,a){super(e,t),this.size=i,this.color=n,this.x_velocity=0,this.y_velocity=0,this.id=a}draw(e){e.beginPath(),e.arc(this.x,this.y,this.size,0,2*Math.PI),e.fillStyle=this.color,e.fill()}update(e,t){this.x=+(this.x+this.x_velocity*e).toFixed(2),this.y=+(this.y+this.y_velocity*e).toFixed(2),this.y_velocity=+(this.y_velocity+500*e).toFixed(2),this.x_velocity=+(this.x_velocity+t*e).toFixed(2)}}class w extends x{constructor(){super(...arguments),this.barrel_angle=0,this.y_velocity=0,this.hp=200}draw(e){if(e.drawImage(this.image,this.x-12,this.y-20,30,21),this.hp>0){let t=this.x+3,i=this.y-16;e.translate(t,i),e.rotate(this.barrel_angle),e.drawImage(this.barrel_image,0,-4,16,8),e.rotate(-this.barrel_angle),e.translate(-t,-i)}e.fillStyle="black",e.textAlign="center",e.fillText(this.username+"-"+this.team.toString(),this.x,this.y-20),e.fillText(this.hp.toString(),this.x,this.y-40),e.beginPath(),e.arc(this.x,this.y,1,0,2*Math.PI),e.fillStyle="red",e.fill()}set_barrel_angle(e){this.barrel_angle=e}fire(e,t,i){let[n,a]=this.get_firing_point(),o=new v(+n.toFixed(2),+a.toFixed(2),3,"#000000",i);o.x_velocity=+(Math.cos(e)*t).toFixed(2),o.y_velocity=+(Math.sin(e)*t).toFixed(2),console.log(o.x_velocity,o.y_velocity),l.push(o)}get_firing_point(){return[this.x+3,this.y-16]}update(e){let t=p.get_at(this.x);this.y<t?(this.y_velocity+=5,this.y+=this.y_velocity*e):(this.y=t,this.y_velocity=0)}}let T=new w(50,50),b=null,E=null,S=null,M=0,k=0,A=0,I="GAME_STATE_PREGAME",N="TURN_STATE_WAITING",W=0,O=0;function P(e){e.style.width="100%",e.style.height="100%",e.width=e.offsetWidth,e.height=e.offsetHeight}let G=0,R=!1,F=0,L=0,z=!1,C=[],D=0,j=0,U=0;function q(e){P(b);const t=(e-M)/1e3;let i=b.getContext("2d");if(p.size){D-=3*j,D=Math.min(0,D),D=Math.max(-(p.size-i.canvas.clientWidth),D);let e=!0,t=!0;0==D?e=!1:D==-(p.size-i.canvas.clientWidth)&&(t=!1),E.style.display=e?"flex":"none",S.style.display=t?"flex":"none"}if("GAME_STATE_PREGAME"==I&&0!=O){i.clearRect(0,0,b.width,b.height);let e=i.font;i.font="30px Comic Sans MS",i.textAlign="center",i.fillText("Players: "+W.toString()+"/"+O.toString(),b.clientWidth/2,b.clientHeight/2),i.fillText("Elapsed time: "+new Date(Date.now()-U).toISOString().slice(14,19),b.clientWidth/2,b.clientHeight/2+30),i.font=e}else if("GAME_STATE_PLAYING"==I){i.clearRect(0,0,b.width,b.height),i.translate(D,0),p.draw(i);for(let e of l)e.update(t,F),e.draw(i);if(r){k=0,A=0;let[e,t]=_(),[n,a]=_(),[o,l]=T.get_firing_point(),s=Math.atan2(a-l,n-o);T.set_barrel_angle(s),i.beginPath(),i.moveTo(o,l),i.lineTo(e,t),i.stroke()}if(k){let[e,t]=T.get_firing_point();i.beginPath(),i.setLineDash([5,5]),i.moveTo(e,t),i.lineTo(k,A),i.stroke(),i.setLineDash([])}for(let e of s.values())e.update(t),e.draw(i);f.length?L+=3:L=0;for(let e of f)e.y+=L,e.y>=p.get_at(e.x)&&(f.splice(f.indexOf(e),1),p.set_at(e.x,p.get_at(e.x)+e.column_height)),i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(e.x,e.y+e.column_height),i.stroke();i.translate(-D,0),i.fillStyle="black",i.textAlign="center";let e=i.font;i.font="30px Comic Sans MS",z?(i.fillText("Game over!",i.canvas.clientWidth/2,30),i.fillText("Winners: "+C.join(", "),i.canvas.clientWidth/2,60)):R?i.fillText("In progress...",i.canvas.clientWidth/2,30):(i.fillText(Math.round(Math.max(0,10+(G-Date.now())/1e3)).toString(),i.canvas.clientWidth/2,30),i.font="16px Comic Sans MS",F<0?i.fillText("< "+F.toFixed(0)+"  ",i.canvas.clientWidth/2,50):F>0?i.fillText("  "+F.toFixed(0)+" >",i.canvas.clientWidth/2,50):i.fillText("  "+F.toFixed(0)+"  ",i.canvas.clientWidth/2,50)),i.font=e}M=e,requestAnimationFrame(q)}function J(e,t){let i=document.createElement("canvas"),n=document.createElement("canvas"),a=i.getContext("2d"),o=n.getContext("2d");i.width=e.width,i.height=e.height,n.width=e.width,n.height=e.height,a.drawImage(e,0,0),a.globalCompositeOperation="source-atop",a.fillStyle=t,a.fillRect(0,0,e.width,e.height),a.globalCompositeOperation="source-over",o.drawImage(e,0,0),o.globalCompositeOperation="color",o.drawImage(i,0,0),o.globalCompositeOperation="source-over";let l=new Image;return l.src=n.toDataURL("image/png"),n.remove(),i.remove(),l}function H(e){d=new WebSocket(e),d.onopen=function(e){U=Date.now(),d.send(JSON.stringify(o.a.token)),requestAnimationFrame(q)},d.onmessage=function(e){console.log(e.data);let t=JSON.parse(e.data);if("your tank"==t.type)T=new w(t.x,t.y),T.color="blue",T.username=t.username,T.image=J(g,T.color),T.barrel_image=J(u,T.color),T.broken_image=J(m,T.color),T.team=t.team,D=-(t.x-b.clientWidth/2),s.set(T.username,T);else if("enemy tank"==t.type){let e=new w(t.x,t.y);e.username=t.username,e.color="red",e.image=J(g,e.color),e.barrel_image=J(u,e.color),e.broken_image=J(m,e.color),e.team=t.team,s.set(t.username,e)}else if("fire"==t.type)s.get(t.player).fire(t.angle,t.force,t.projectile_id),s.get(t.player).set_barrel_angle(t.angle),k=0,A=0;else if("event_player_count"==t.type)W=t.have,O=t.need;else if("event_game_start"==t.type)I="GAME_STATE_PLAYING",G=Date.now();else if("turn_ended"==t.type)N="TURN_STATE_RUNNING",R=!0;else if("terrain"==t.type)p.set_heightmap(t.terrain);else if("impact"==t.type)p.apply(t.start_point,t.modifications),l=l.filter(e=>e.id!=t.projectile_id);else if("next_turn"==t.type)G=Date.now(),R=!1,k=0,A=0,N="TURN_STATE_WAITING";else if("damage"==t.type)s.get(t.player).hp-=t.amount;else if("death"==t.type){let e=s.get(t.player);e.image=e.broken_image}else"victory"==t.type?(z=!0,C=t.victors):"wind"==t.type&&(F=t.strength)},d.onclose=function(e){console.log("closing"),console.log(e.code)}}class Y extends a.a.Component{componentDidMount(){b=this.refs.game,P(b),g=new Image,g.crossOrigin="anonymous",g.src="/src/public/tank.png",g.onload=()=>{u=new Image,u.crossOrigin="anonymous",u.src="/src/public/tank_barrel.png",u.onload=()=>{m=new Image,m.crossOrigin="anonymous",m.src="/src/public/tank_broken.png",m.onload=()=>{o.b.address?H(o.b.address):Object(o.c)("/game/request/").then(e=>{H(e.data)})}}},b.addEventListener("mousedown",e=>{"TURN_STATE_WAITING"==N&&(r=!0)}),b.addEventListener("mouseup",e=>{if(!r)return;r=!1;let[t,i]=_();[k,A]=[t,i],t-=T.x,i-=T.y;let n=Math.sqrt(t*t+i*i),a=Math.atan2(i,t);d.send(JSON.stringify({type:"fire",angle:a,force:3*n}))}),b.addEventListener("mousemove",e=>{[h,c]=function(e,t){let i=e.getBoundingClientRect();return[t.x-i.left,t.y-i.top]}(b,e)}),S=this.refs.scroll_right,S.addEventListener("mousedown",e=>{j=1}),S.addEventListener("mouseup",e=>{j=0}),E=this.refs.scroll_left,E.addEventListener("mousedown",e=>{j=-1}),E.addEventListener("mouseup",e=>{j=0})}render(){return a.a.createElement("div",{className:"game_container"},a.a.createElement("div",{ref:"scroll_right",className:"canvas_scroll_right"},">"),a.a.createElement("canvas",{ref:"game"}),a.a.createElement("div",{ref:"scroll_left",className:"canvas_scroll_left"},"<"))}}},47:function(e,t,i){"use strict";i.d(t,"c",(function(){return r})),i.d(t,"e",(function(){return h})),i.d(t,"d",(function(){return c})),i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return g}));var n=i(56),a=i.n(n),o=i(57),l=i.n(o);const s="https://micromstag.westeurope.cloudapp.azure.com:443/api/v1";function r(e){return d.token?a.a.get(s+e,{headers:{Authorization:"Token "+d.token}}):a.a.get(s+e)}function h(e,t){return d.token?a.a.post(s+e,t,{headers:{Authorization:"Token "+d.token}}):a.a.post(s+e,t)}function c(e){return l()(s+e,{method:"GET",headers:{Authorization:"Token "+d.token}},{metadata:!0})}const d={username:"",player_id:-1,token:""},g={address:""}}}]);